<?php

namespace App\Console\Commands\Tools\Debug\VulnerabilityImport;

use Illuminate\Console\Command;
use App\Libs\Providers\Vulnerabilities\Javascript\Nodejs\SecurityWG as Provider;
use App\Libs\Modules\Import\Vulnerabilities\Javascript\Nodejs\SecurityWG as Module;
use App\Libs\Helpers\Vulnerabilities;
use App\Libs\Helpers\Products;

class NodeJS extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'tools:debug:vuln-import:securitywg {cve}';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Import a CVE from NodeJS SecurityWG';

    /**
     * Execute the console command.
     */
    public function handle()
    {
        $cve = $this->argument('cve');

        $provider = new Provider();
        $items = $provider->getVulnerabilities();

        foreach ($items as $package => $vulns) {
            foreach ($vulns as $vuln) {
                if (isset($vuln->cves)) {
                    foreach ($vuln->cves as $vulnCve) {
                        if($vulnCve == strtoupper($cve)){
                            $module = new Module();
                            $product = Products::createJavascriptProduct($package);
                            $this->line('Product: ' . $product->name);
                            $data = $module->parseVulnerabilityData($product->id, $vuln);
                            $vulnerability = Vulnerabilities::createVulnerability($data);
                            $this->line('Vulnerability created: ' . $vulnerability->id);
                            return;
                        }
                    }
                }
            }
        }
    }
}
