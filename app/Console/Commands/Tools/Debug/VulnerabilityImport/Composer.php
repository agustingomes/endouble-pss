<?php

namespace App\Console\Commands\Tools\Debug\VulnerabilityImport;

use Illuminate\Console\Command;
use App\Libs\Providers\Vulnerabilities\Composer\SecurityAdvisories as Provider;
use App\Libs\Modules\Import\Vulnerabilities\Composer\SecurityAdvisories as Module;
use App\Libs\Helpers\Vulnerabilities;
use App\Libs\Helpers\Products;

class Composer extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'tools:debug:vuln-import:composer {cve}';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Import a CVE from Composer SecurityAdvisories';

    /**
     * Execute the console command.
     */
    public function handle()
    {
        $cve = $this->argument('cve');

        $provider = new Provider();
        $vulns = $provider->getVulnerabilities();

        foreach ($vulns as $vendor => $products) {
            foreach ($products as $product => $vulnerabilities) {
                foreach ($vulnerabilities as $details) {
                    if (isset($details['cve']) && $details['cve'] == strtoupper($cve)) {
                        $module = new Module();
                        $product = Products::createComposerProduct($vendor . '/' . $product);
                        $this->line('Product: ' . $product->name);
                        $data = $module->parseVulnerabilityData($product->id, $details);
                        $vulnerability = Vulnerabilities::createVulnerability($data);
                        $this->line('Vulnerability created: ' . $vulnerability->id);
                    }
                }
            }
        }
    }
}
